# UnityMCP 活用ルール（常時適用）

このプロジェクトには **UnityMCP** が導入されており、AIエージェントは MCP ツールを通じて Unity エディタと直接通信できる。このルールは MCP ツールの使用に関する行動規範を定義する。

---

## 1. 推測の禁止 — 必ず事実を確認してから回答すること

シーンの構造、アセットの存在、スクリプトの実装内容、コンポーネントの設定値について **推測で回答してはならない**。回答を生成する前に、必ず以下の MCP ツールで事実を確認すること。

| 確認対象 | 使用する MCP ツール |
|---|---|
| シーン内の GameObject 構成 | `manage_scene` (action: `get_hierarchy`) |
| 特定の GameObject の存在・検索 | `find_gameobjects` (by_name, by_tag, by_component 等) |
| GameObject のコンポーネント詳細 | リソース `mcpforunity://scene/gameobject/{id}/components` |
| アセットの存在確認・検索 | `manage_asset` (action: `search`) |
| C# スクリプトの内容 | `manage_script` (action: `read`) または `find_in_file` |
| コンソールログ・エラー | `read_console` |
| エディタの状態（再生中かどうか等） | `manage_editor` (action: `telemetry_status`) |

### 禁止される行動

- 「おそらく〇〇が原因です」と MCP 確認なしに推測すること
- ユーザーが言及した GameObject やスクリプトの存在を確認せずにコードを提示すること
- Inspector の設定値を確認せずに「値が正しくない可能性があります」と述べること

### 正しい行動

1. ユーザーの質問を受け取る
2. 関連する MCP ツールを実行して事実を取得する
3. 取得した事実に基づいて回答を生成する

---

## 2. コンテキストの自律的取得 — 聞き返す前に自分で調べること

ユーザーから以下のような報告を受けた場合、**詳細を聞き返す前に**、まず MCP ツールで情報を自ら収集すること。

| ユーザーの報告 | 即座に実行すべきアクション |
|---|---|
| 「エラーが出た」「赤いログが出た」 | `read_console` でエラーログとスタックトレースを取得する |
| 「〇〇が動かない」「挙動がおかしい」 | `read_console` でログ確認 → `find_gameobjects` で対象の存在確認 → コンポーネントリソースで状態確認 |
| 「〇〇のスクリプトを修正して」 | `manage_script` (action: `read`) でファイルの現在の内容を読む → `find_in_file` で修正対象箇所を特定 |
| 「NullReferenceException が出た」 | `read_console` (include_stacktrace: true) → スタックトレースからファイル名・行番号を抽出 → 該当ファイルを `manage_script` で読み込む |
| 「シーンに〇〇を追加して」 | `manage_scene` (action: `get_hierarchy`) で現在のシーン構成を確認してから作業する |

### 禁止される行動

- 「エラーメッセージを貼ってください」とユーザーに聞き返すこと（MCP で取得できるため）
- 「そのスクリプトの内容を見せてください」とユーザーに聞き返すこと（MCP で読めるため）
- 「そのオブジェクトはシーンにありますか？」とユーザーに聞き返すこと（MCP で検索できるため）

### 例外（聞き返してよい場合）

- ユーザーの意図や仕様要件が不明瞭な場合（「どのような動作を期待していますか？」）
- MCP ツールで取得できない情報（ハードウェアの物理的状態、ネットワーク環境など）

---

## 3. コード修正時の正確な差分の提示

コードを修正する際は、以下の手順に従うこと。

### 手順

1. **対象ファイルの特定:** `manage_asset` (action: `search`) や `find_in_file` でファイルパスを正確に特定する
2. **現在の内容の読み込み:** `manage_script` (action: `read`) でファイルの最新の内容を取得する
3. **修正箇所の特定:** `find_in_file` で修正対象のパターンを検索し、正確な行番号を把握する
4. **修正の適用:** 以下の優先順位で修正方法を選択する：
   - **メソッド単位の置換:** `script_apply_edits` (op: `replace_method`) を使用する（最も安全）
   - **パターンベースの挿入/置換:** `script_apply_edits` (op: `anchor_insert` / `anchor_replace`) を使用する
   - **行指定の編集:** `apply_text_edits` で正確な行・列を指定する（事前に `find_in_file` で位置を確認すること）
   - **新規ファイル作成:** `create_script` を使用する
5. **修正後の確認:** `validate_script` で構文チェックを実行する。エラーがあれば修正を繰り返す
6. **リフレッシュ:** `refresh_unity` でアセットデータベースを更新し、コンパイルエラーが発生していないか `read_console` で確認する

### 禁止される行動

- ファイルパスを推測してコードを提示すること（必ず MCP で実在を確認する）
- 修正コードだけを提示して「このように書き換えてください」とユーザーに手作業を委ねること（MCP で直接編集できる場合はツールを使用する）
- 修正後に `validate_script` や `read_console` を確認せず完了報告すること

---

## 4. バッチ処理の活用

複数の GameObject やコンポーネントに対して同種の操作を行う場合、個別のツール呼び出しを繰り返さず、`batch_execute` を使用して 1 回のリクエストにまとめること。これによりレイテンシとトークンコストを大幅に削減できる。

### 例

- 5 つの Cube を作成する → `batch_execute` で 5 つの `manage_gameobject` (action: `create`) をまとめる
- 複数の GameObject にコンポーネントを追加する → `batch_execute` で `manage_components` (action: `add`) をまとめる

---

## 5. スクリーンショットの活用

視覚的な確認が有効な場面では、`manage_scene` (action: `screenshot`) を使用してエディタのスクリーンショットを取得すること。特に以下の場面で活用する。

- UI レイアウトの確認・調整時
- シーン上のオブジェクト配置の確認時
- ユーザーに現在の状態を視覚的に報告する場合
